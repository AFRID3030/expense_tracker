<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Download Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 30px;
        }
        .container {
            max-width: 600px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">üì• Download Reports</h2>

    <!-- Month/Year Selection -->
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="month" class="form-label">Select Month</label>
            <select id="month" class="form-select">
                <option value="">All</option>
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="year" class="form-label">Select Year</label>
            <input type="number" id="year" class="form-control" value="2025" min="2000" max="2100">
        </div>
    </div>

    <!-- Download Buttons-->
    <div class="d-grid gap-2">
        <button onclick="downloadExpense()" class="btn btn-primary">üí∞ Download Expenses</button>
        <button onclick="downloadIncome()" class="btn btn-success">üíµ Download Income</button>
        <button onclick="goBack()" class="btn btn-secondary mt-3">‚¨ÖÔ∏è Back to Dashboard</button>
    </div>
</div>

<script>
    function getMonthYearQuery() {
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        let query = '';
        if (month) query += `month=${month}&`;
        if (year) query += `year=${year}&`;
        return query ? `?${query.slice(0, -1)}` : '';
    }

    function downloadFile(url, filename) {
        const token = localStorage.getItem('access_token');
        fetch(url, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to download file');
            return response.blob();
        })
        .then(blob => {
            const fileUrl = window.URL.createObjectURL(new Blob([blob]));
            const a = document.createElement('a');
            a.href = fileUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => alert('Error: ' + error.message));
    }

    function downloadExpense() {
        downloadFile(`/api/download-expenses/${getMonthYearQuery()}`, 'expenses.xlsx');
    }

    function downloadIncome() {
        downloadFile(`/api/download-income/${getMonthYearQuery()}`, 'income.xlsx');
    }

    function goBack() {
        window.location.href = '/dashboard-page/';
    }
</script>

</body>
</html>
